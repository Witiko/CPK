<?
$accessLevel = $this->driver->getAccessLevel();
$restrictedView = empty($accessLevel) ? false : true;
$recordId = $this->driver->getUniqueID();
$recordSource = explode(".", $recordId)[0];
$format = $this->driver->getPubTypeId();
$items = $this->driver->getItems();
$lookfor = $this->results->getUrlQuery()->isQuerySuppressed() ? '' : $this->params->getDisplayQuery();
//var_dump($this->driver); exit();
//var_dump($items); exit();
if (empty($lookfor)) {
    $lookfor = $this->record($this->driver)->getObalkyKnihAdvert('results');
}

$recordIdHash = md5($recordId);
$this->headScript()->appendFile("jquery-ui.min.js");
$issns = $this->driver->getIssns();
$isbns = $this->driver->getIsbns();
$publishDate = $this->driver->getPublishDate();
$titles = $this->driver->getTitles();
$authors = $this->driver->getAuthors();
$sourceTitle = $this->driver->getSourceTitle();
$volume = $this->driver->getVolume();
//var_dump($issns);exit();
?>
<div class="white-box clearfix">
    <div class="row col-xs-12 source<?=$this->escapeHtmlAttr($this->driver->getSourceIdentifier())?> recordId<?=$this->driver->supportsAjaxStatus()?' ajaxItemId':''?>">
        <input type="hidden" value="<?=$this->escapeHtmlAttr($this->driver->getUniqueID())?>" class="hiddenId" />
        <div class="col-sm-2 col-xs-3 left">

            <div class="coverThumbnail cover_<?=$id?>">
                <? if (! empty($format)): ?>
                    <div class="iconlabel"><i style="font-size: 70px; color: #cccccc;" class="pr-format-eds-<?=$format?>"></i></div>
                <? else: ?>
                    <div class="iconlabel"><i style="font-size: 70px; color: #cccccc;" class="pr-format-eds-unknown"></i></div>
                <? endif; ?>
            </div>

        </div>
        <div class="col-sm-7 col-xs-7 middle search-result-container">
            <?  $items  =  $this->driver->getItems();
            if (isset($items) && !empty($items)) :
                foreach ($items as $item):
                    if (!empty($item)): ?>
                        <div class="resultItemLine1">
                            <? if ('Ti' == $item['Group']): ?>
                                <div class="root-title">
                                    <a href="<?=$this->recordLink()->getUrl($this->driver)?>" class="title _record_link">
                                        <?=$item['Data']?>
                                    </a>
                                </div>
                            <? elseif ('Au' == $item['Group']): $author = $item['Data'];?>
                                <span title='<?=$this->translate('Show publications by')?> <?=strip_tags($author)?>' class='eds-author-info'>
                                    <?=$author?>
                                </span>
                            <? else: ?>
                                <p>
                                    <b><?=$this->transEsc($item['Label'])?>:</b>
                                    <?=$item['Data']?>
                                </p>
                            <? endif; ?>
                        </div>
                    <? endif;
                endforeach;
            elseif ($restrictedView): ?>
                <div class="resultItemLine1">
                    <p>
                        <?=$this->transEsc('This result is not displayed to guests')?>
                        <br />
                        <a class="login" href="<?=$this->url('myresearch-home')?>">
                            <strong><?=$this->transEsc('Login for full access')?></strong>
                        </a>
                    </p>
                </div>
            <? endif; ?>

            <div class='row'>
                <div class='col-md-8'>
                    <div class="format-list pull-left inline-block">
                        <? if (! empty($format)): ?>
                            <div class="iconlabel" style="color: #777;">
                                <i class="small-format-icon pr-format-eds-<?=$format?>"></i>
                                <span class="format-text">
                                    <?= $this->translate($format) ?>
                                </span>
                            </div>
                        <? endif; ?>
                    </div>
                </div>
                <div class='col-md-4 search-results-favorite-button hidden pull-right'>
                    <? if ($this->userlist()->getMode() !== 'disabled'):
                        $controllerClass = 'controller:' . $this->record($this->driver)->getController();
                        $handleOfflineFavorites = ! $this->isLoggedIn && $this->offlineFavoritesEnabled; ?>
                        <li class="list-group-item">
                            <a id="save-record" class="modal-link <?=$controllerClass?>"

                                <? if ($handleOfflineFavorites) : ?>
                                    href="#" data-ng-click="searchFavCtrl.addOrRemoveFavorite(<?=isset($_ENV['currentRecordNo']) ? $_ENV['currentRecordNo'] : '' ?>)"
                                <? else: ?>
                                    href="<?=$this->recordLink()->getActionUrl($this->driver, 'Save')?>"
                                <? endif; ?>

                               title="<?=$this->transEsc('Add to favorites')?>" rel="nofollow"><i class="pr-interface-favoritestar"> </i>
                                <span data-add-remove-search="add<?=isset($_ENV['currentRecordNo']) ? ':' . $_ENV['currentRecordNo'] : '' ?>"><?=$this->transEsc('Add to favorites')?></span>
                                <span data-add-remove-search="rem<?=isset($_ENV['currentRecordNo']) ? ':' . $_ENV['currentRecordNo'] : '' ?>" hidden ><b><?=$this->transEsc('remove_from_favorites')?></b></span>
                            </a></li>
                    <? endif; ?>
                </div>
            </div>
          
        </div>

        <div class="col-sm-3 col-xs-12 right">
            <div id="eds-links">

                <span id="only-one-eds-link-header-<?=$recordIdHash?>" class="records-in-libraries-title" style="display: none; font-size: 110%;"><?= $this->translate('Fulltext is avalable for users of this institution') ?>:</span>
                <span id="many-eds-links-header-<?=$recordIdHash?>" class="records-in-libraries-title" style="display: none; font-size: 110%;"><?= $this->translate('Fulltext is avalable for users of these institutions') ?>:</span>

                <table class="table table-striped">
                    <tbody>
                        <div id="eds-links-placeholder-<?=$recordIdHash?>">
                            <!-- Ajax Placeholder -->
                        </div>
                    </tbody>
                </table>

            </div>
        </div>

        <!--<div class="col-sm-2 right hidden-print">
            <? /* Display qrcode if appropriate: */ ?>
            <? if ($QRCode = $this->record($this->driver)->getQRCode("results")): ?>
                <?
                // Add JS Variables for QrCode
                $this->jsTranslations()->addStrings(array('qrcode_hide' => 'qrcode_hide', 'qrcode_show' => 'qrcode_show'));
                ?>
                <span class="hidden-xs">
            <i class="fa fa-fw fa-qrcode"></i> <a href="<?=$this->escapeHtmlAttr($QRCode);?>" class="qrcodeLink"><?=$this->transEsc('qrcode_show')?></a>
            <div class="qrcode hidden">
              <script type="text/template" class="qrCodeImgTag">
                <img alt="<?=$this->transEsc('QR Code')?>" src="<?=$this->escapeHtmlAttr($QRCode);?>"/>
              </script>
            </div><br/>
          </span>
            <? endif; ?>

            <? if ($this->userlist()->getMode() !== 'disabled'): ?>
                <? /* Add to favorites */ ?>
                <i class="fa fa-fw fa-star"></i> <a href="<?=$this->recordLink()->getActionUrl($this->driver, 'Save')?>" class="save-record modal-link" id="<?=$this->driver->getUniqueId() ?>" title="<?=$this->transEsc('Add to favorites')?>"><?=$this->transEsc('Add to favorites')?></a><br/>

                <? /* Saved lists */ ?>
                <div class="savedLists alert alert-info hidden">
                    <strong><?=$this->transEsc("Saved in")?>:</strong>
                </div>
            <? endif; ?>

            <? /* Hierarchy tree link */ ?>
            <? $trees = $this->driver->tryMethod('getHierarchyTrees'); if (!empty($trees)): ?>
                <? foreach ($trees as $hierarchyID => $hierarchyTitle): ?>
                    <div class="hierarchyTreeLink">
                        <input type="hidden" value="<?=$this->escapeHtmlAttr($hierarchyID)?>" class="hiddenHierarchyId" />
                        <i class="fa fa-fw fa-sitemap"></i>
                        <a class="hierarchyTreeLinkText modal-link" href="<?=$this->recordLink()->getTabUrl($this->driver, 'HierarchyTree')?>?hierarchy=<?=urlencode($hierarchyID)?>#tabnav" title="<?=$this->transEsc('hierarchy_tree')?>">
                            <?=$this->transEsc('hierarchy_view_context')?><? if (count($trees) > 1): ?>: <?=$this->escapeHtml($hierarchyTitle)?><? endif; ?>
                        </a>
                    </div>
                <? endforeach; ?>
            <? endif; ?>
        </div>-->

        <!--<div class="format-list pull-left inline-block">
            <?=$this->record($this->driver)->getFormatList()?>
        </div>-->

    </div>
</div>

<script>
    jQuery( document ).ready( function( $ ) {

        $.ajax({
            method: 'POST',
            dataType: 'json',
            async: true,
            url: '/AJAX/JSON?method=getEdsFulltextLinkInResults&recordIdHash=<?=$recordIdHash?>',
            data: {
                recordData: {
                    <? if (! empty($recordId)): ?> <?= "'recordId': '".$recordId."'," ?> <? endif; ?>
                }
            },
            beforeSend: function () {
                console.info( 'Calling getEdsFulltextLinkInResults for recordId <?=$recordIdHash?>..' );
                $('#eds-links-placeholder-<?=$recordIdHash?>').append("<div class='eds-links-loader text-center'><i class='fa fa-2x fa-refresh fa-spin'></i></div>");
            },
            success: function (response) {

                if (response.status == 'OK') {
                    console.log( '' );
                    console.log( 'Eds fulltext links FOUND for recordId <?=$recordIdHash?>.' );
                    console.log( 'Solr url: ' + response.data.url );

                    var links = response.data.links;
                    var edsLinks = links.length;

                    var ebscoHtml = "";
                    links.forEach( function( link ) {
                        ebscoHtml += "<tr style='display: none;'><td>" + link + "</td></tr>";
                    });

                    if (edsLinks == 1) {
                        $( '#many-eds-links-header-<?=$recordIdHash?>' ).hide( 'blind', {}, 200 );
                        $( '#only-one-eds-link-header-<?=$recordIdHash?>' ).show( 'blind', {}, 200 );
                    }

                    if (edsLinks > 1) {
                        $( '#only-one-eds-link-header-<?=$recordIdHash?>' ).hide( 'blind', {}, 200 );
                        $( '#many-eds-links-header-<?=$recordIdHash?>' ).show( 'blind', {}, 200 );
                    }

                    $('#eds-links-placeholder-<?=$recordIdHash?>').append( ebscoHtml );
                    $('#eds-links-placeholder-<?=$recordIdHash?> tr').show( 'blind', {}, 200 );
                }

                if (response.status == 'NOT FOUND') {
                    console.log( '' );
                    console.warn( 'Eds fulltext links NOT FOUND for recordId <?=$recordIdHash?>.' );
                    if (response.data.url) {
                        console.log('Solr url: ' + response.data.url);
                    }
                }

                if (response.status == 'FOUND INVALID LINKS') {
                    console.log( '' );
                    console.warn( 'Eds fulltext links FOUND but links are INVALID for recordId <?=$recordIdHash?>.' );
                    if (response.data.url) {
                        console.log('Solr url: ' + response.data.url);
                    }
                }

            },
            complete: function () {
                $( '#eds-links-placeholder-<?=$recordIdHash?> .eds-links-loader' ).remove();
            },
            error: function ( jqXHR, textStatus, errorThrown ) {
                console.error( JSON.stringify( jqXHR ) );
                console.error( 'AJAX error: ' + textStatus + ' : ' + errorThrown );
            }
        });

    });
</script>